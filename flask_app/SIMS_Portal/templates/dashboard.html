<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% extends "layout.html" %}
{% block content %}
	<div class="container">
		<div class="mt-4" id="hideMe">
			{% with messages = get_flashed_messages(with_categories=true) %}
				   {% if messages %}
					   {% for category, message in messages %}
						   <div class="alert alert-{{ category }}">
							   {{ message }} 
						   </div>
					   {% endfor %}
				   {% endif %}
			{% endwith %}
		</div>
		<div class="row mb-3">
			{% if pending_user_check|length == 1 and current_user.is_admin == 1 %}
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			  There is one new user account pending approval. Go to the Admin Portal to approve or reject the request.
			</div>
			{% endif %}
			
			{% if pending_user_check|length > 1 and current_user.is_admin == 1 %}
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			  There are {{pending_user_check|length}} new user accounts pending approval. Go to the Admin Portal to approve or reject their requests.
			</div>
			{% endif %}
		</div>
		<div class="row">
			{% if count_active_emergencies > 0 %}
			<h3 class="Montserrat">Active Operations: <span class='text-danger'>{{count_active_emergencies}}</span></h3>
			<div class="row row-cols-1 row-cols-md-2 g-4" id='active-disaster-dashboard'>
				{% for emergency in active_emergencies %}  
				<a href='/emergency/{{emergency.Emergency.id}}'>
				<div class="col d-flex align-items-stretch">  
					<div class='card bg-light portfolio-card'>
						<div class="card-body d-flex flex-column">
						<div class='row align-items-center'>
						  <div class='col-3 p-4'>
							  <img class="img-fluid" src="/static/assets/img/emergency_types/{{emergency.EmergencyType.emergency_type_name}}.png" />
						  </div>
						  <div class='col p-4'>
							  <h2 class="Montserrat text-danger">{{emergency.Emergency.emergency_name}}</h2>
						  </div>
						</div>
					</div>
					</div>
				</div>
				</a>
				{% endfor %}
			</div>

			{% endif %}
			
		</div>
			<div class='mb-5'>
			{% if count_active_assignments == 0 %}
				<h3 class="mt-5 Montserrat">No Active Assignments</h3>
				<h5 class="text-secondary mb-5">It's a good time to work on your skills to be ready for the next SIMS activation! Check out the learning and development section to find useful resources.</h5>
				
			{% else %}
			<h3 class="mt-5 Montserrat">Active Assignments: <span class='text-danger'>{{count_active_assignments}}</span></h3>
			<h5 class="text-secondary mb-3">Members Currently Supporting Operations</h5>
			<table class='table table-striped table-hover'>
				<thead>
					<tr>
						<th>Member</th>
						<th>Affiliation</th>
						<th>Emergency</th>
						<th>Assignment</th>
						<th>Start</th>
						<th>End</th>
					</tr>
				</thead>
				<tbody>
					{% for assignment in active_assignments %}
						<tr>
							<td class="fw-bold"><a href="/profile/view/{{assignment.Assignment.user_id}}" class='link-danger'>{{assignment.User.firstname}} {{assignment.User.lastname}}</a></td>
							<td>{{assignment.NationalSociety.ns_name}}</td>
							<td><a href="/emergency/{{assignment.Assignment.emergency_id}}" class='link-danger'>{{assignment.Emergency.emergency_name}}</a></td>
							<td><a href='/assignment/{{assignment.Assignment.id}}'>{{assignment.Assignment.role}}</a></td>
							<td>{{assignment.Assignment.start_date}}</td>
							<td>{{assignment.Assignment.end_date}}</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
			{% endif %}
			</div>
			<div class='mb-5'>
			<h3 class="mb-4" style="font-family: 'Montserrat'">Data Overview</h3>
			<ul class="nav nav-tabs" id="dashboardNav" role="tablist">
				<li class="nav-item" role="presentation">
				<button class="nav-link active text-danger" id="assignments-emergency-tab" data-bs-toggle="tab" data-bs-target="#assignments-emergency" type="button" role="tab" aria-controls="assignments-emergency" aria-selected="true">Assignments by Emergency</button>
				</li>
				
				<li class="nav-item" role="presentation">
				<button class="nav-link text-danger" id="location-emergencies-tab" data-bs-toggle="tab" data-bs-target="#location-emergencies" type="button" role="tab" aria-controls="assignments-emergency" aria-selected="false">Global Response History</button>
				</li>

				<li class="nav-item" role="presentation">
				<button class="nav-link text-danger" id="products-emergency-tab" data-bs-toggle="tab" data-bs-target="#products-emergency" type="button" role="tab" aria-controls="products-emergency" aria-selected="false">Products by Emergency</button>
				</li>
				
			</ul>
			<div class="tab-content" id="dashboardContent">
				<div class="tab-pane fade" id="location-emergencies" role="tabpanel" aria-labelledby="location-emergencies-tab">
					<div class="map">
						<svg class='my-3' id="response-history-map" width='1300' height='700'></svg>
						
						<script>
						
						var svg = d3.select("svg"),
						  width = +svg.attr("width"),
						  height = +svg.attr("height");
						
						// Map and projection
						var path = d3.geoPath();
						var projection = d3.geoMercator()
						  .scale(150)
						  .center([0,20])
						  .translate([width / 2, height / 2]);
						
						// Data and color scale
						var data = d3.map();
						var colorScale = d3.scaleThreshold()
						  .domain([1, 2, 3, 4])
						  .range(d3.schemeReds[4]);
						
						// Load external data and boot
						d3.queue()
						  .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
						  .defer(d3.csv, "/static/data/emergencies_viz.csv", function(d) { data.set(d.iso3, +d.count); })
						  .await(ready);
						
						function ready(error, topo) {
						
						  // Draw the map
						  svg.append("g")
							.selectAll("path")
							.data(topo.features)
							.enter()
							.append("path")
							  // draw each country
							  .attr("d", d3.geoPath()
								.projection(projection)
							  )
							  // set the color of each country
							  .attr("fill", function (d) {
								d.total = data.get(d.id) || 0;
								return colorScale(d.total);
							  });
							}
							
							
						
						</script>
						
						<h4 style="text-align:center">Find a full list of responses with links their respective pages on the <a href='/emergencies/all'>Emergencies</a> page.
						
					  </div>
				</div>
			  <div class="tab-pane fade show active" id="assignments-emergency" role="tabpanel" aria-labelledby="assignments-emergency-tab">
				  <br>
				  <canvas id='barChartAssignments' width='1200' height='300'></canvas>
				  <script>
					  var ctx = document.getElementById('barChartAssignments').getContext('2d');
					  var lineChart = new Chart(ctx, {
						  type: 'bar',
						  data: {
							  labels: {{ labels_for_assignment | safe }},
							  datasets: [{
								  label: "Assignments by Emergency, All Time",
								  data: {{ values_for_assignment | safe }},
								  fill: true,
								  backgroundColor: "#dc3545"
							  }]
						  },
						  options: {
							  responsive: true,
							  indexAxis: 'y',
							  scales: {
								  y: {
									  ticks: {
										  stepSize: 1
									  },
									  grid: {
										  display: false
									  }
									  
								  },
								  x: {
									  grid: {
										  display: false
									  }
								  }
								  
							  }
						  }
					  })
				  </script>
				  
			  </div>
			  <div class="tab-pane fade" id="products-emergency" role="tabpanel" aria-labelledby="products-emergency-tab">
				  <br>
					<canvas id='barChartProducts' width='1200' height='300'></canvas>
					<script>
						var ctx = document.getElementById('barChartProducts').getContext('2d');
						var lineChart = new Chart(ctx, {
							type: 'bar',
							data: {
								labels: {{ labels_for_product | safe }},
								datasets: [{
									label: "Products by Emergency, All Time",
									data: {{ values_for_product | safe }},
									fill: true,
									backgroundColor: "#dc3545"
								}]
							},
							options: {
								responsive: true,
								indexAxis: 'y',
								scales: {
									y: {
										ticks: {
											stepSize: 1
										},
										grid: {
											display: false
										}
										
									},
									x: {
										grid: {
											display: false
										}
									}
									
								}
							}
						})
					</script>
				  
			  </div>
			</div>
			</div>

		</div>
		

		

	</div>
{% endblock content %}

