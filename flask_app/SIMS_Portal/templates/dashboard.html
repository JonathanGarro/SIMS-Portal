<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% extends "layout.html" %}
{% block content %}
	<div class="container">
		<div id="hideMe">
			{% with messages = get_flashed_messages(with_categories=true) %}
				   {% if messages %}
					   {% for category, message in messages %}
						   <div class="mt-4 alert alert-{{ category }}">
							   {{ message }} 
						   </div>
					   {% endfor %}
				   {% endif %}
			{% endwith %}
		</div>
	</div>
	<div class="container mt-3">
		<div class="row">
			{% if pending_user_check|length == 1 and current_user.is_admin == 1 %}
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			  There are new accounts pending approval. Go to the <a href='/admin/approve_members'>Admin Portal</a> to approve or reject the requests.
			</div>
			{% endif %}
			{% if pending_user_check|length > 1 and current_user.is_admin == 1 %}
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			  There are {{pending_user_check|length}} new user accounts pending approval. Go to the Admin Portal to approve or reject their requests.
			</div>
			{% endif %}
		</div>
		<div class='container'>
			<div class='d-flex justify-content-between mt-2 mb-5 bg-light rounded border-3 border px-4 py-3'>
				<div>
					<h2 class='text-dark Montserrat pe-4'>Dashboard</h2>
				</div>
				<div>
				<ul class="nav nav-pills" id="dashboardNav" role="tablist">
				  <li class="nav-item" role="presentation">
					<button class="nav-link active" id="active-ops-tab" data-bs-toggle="pill" data-bs-target="#active-ops" type="button" role="tab" aria-controls="active-ops" aria-selected="true">Active Operations</button>
				  </li>
				  <li class="nav-item" role="presentation">
					<button class="nav-link" id="surge-alerts-tab" data-bs-toggle="pill" data-bs-target="#surge-alerts" type="button" role="tab" aria-controls="surge-alerts" aria-selected="false">Surge Alerts</button>
				  </li>
				  <li class="nav-item" role="presentation">
					<button class="nav-link" id="data-overview-tab" data-bs-toggle="pill" data-bs-target="#data-overview" type="button" role="tab" aria-controls="data-overview" aria-selected="false">Data Overview</button>
				  </li>
				</ul>
				</div>
			</div>
			<div class='row'>
				<div class="tab-content" id="dashboardContent">
					<div class="tab-pane show fade active" id="active-ops" role="tabpanel" aria-labelledby="active-ops-tab">
						<div class='row'>
							<div class='col-lg-4 min-width-custom mb-3'>
								<div class="card card-bg-red border-3 text-decoration-none pt-5 px-sm-3 px-md-0 px-lg-3 pb-sm-3 pb-md-0 pb-lg-3 me-xl-2 mt-4">
									<div class="card-body pt-3">
									  	<div class="d-inline-block bg-danger border border-3 border-white shadow-primary rounded-3 position-absolute top-0 translate-middle-y p-3" >
									  		<h1 class='text-light fw-bold px-3'>{{count_active_emergencies}}</h1>
										</div>
											<h2 class="d-inline-flex align-items-center text-light Montserrat mb-4">Active Response{% if count_active_emergencies != 1 %}s{% endif %}</h2>
											{% for emergency in active_emergencies %}  
											<a href='/emergency/{{emergency.Emergency.id}}'>
											<div class="col d-flex align-items-stretch">  
											<div class='card border-0 bg-light portfolio-card mb-2'>
												<div class="card-body d-flex flex-column">
											  	<div class='row align-items-center'>
													<div class='col-3'>
														<img class="img-fluid" src="/static/assets/img/emergency_types/{{emergency.EmergencyType.emergency_type_name}}.png" />
													</div>
													<div class='col'>
														<h4 class="Montserrat text-secondary">{{emergency.Emergency.emergency_name}}</h4>
													</div>
											  	</div>
										  	</div>
									  	</div>
									  	</div>
									  	</a>
									  	{% endfor %}
								  	</div>
								</div>
							</div>
							<div class='col ms-2'>
								<div class="mt-2">
									<rect style="fill: none; stroke: #404040; stroke-width: .5px;">
									<svg viewBox="-450 -300 950 550" preserveAspectRatio="none"></svg>
									</rect>
								</div>
								<script>
								// config
								const color0 = 'rgb(237, 237, 237)'
								const color1 = 'rgb(13, 15, 16)'
								
								var svg = d3.select("svg"),
								  width = +svg.attr("width"),
								  height = +svg.attr("height");
								
								// Map and projection
								var path = d3.geoPath();
								var projection = d3.geoMercator()
								  .scale(150)
								  .center([0,20])
								  .translate([width / 2, height / 2]);
								
								// Data and color scale
								var data = d3.map();
								var colorScale = d3.scaleThreshold()
								  .domain([1])
								  .range([color0, color1]);
								
								// Load external data and boot
								d3.queue()
								  .defer(d3.json, "/static/data/response-locations-base.json")
								  .defer(d3.csv, "/static/data/active_emergencies.csv", function(d) { data.set(d.iso3, +d.count); })
								  .await(ready);
								
								function ready(error, topo) {
								
								  // Draw the map
								  svg.append("g")
									.selectAll("path")
									.data(topo.features)
									.enter()
									.append("path")
									  // draw each country
									  .attr("d", d3.geoPath()
										.projection(projection)
									  )
									  // set the color of each country
									  .attr("fill", function (d) {
										d.total = data.get(d.id) || 0;
										return colorScale(d.total);
									  })
									  ;
									}
								</script>
							</div>
						</div>
						<div class='row mt-5'>
							{% if count_active_assignments == 0 %}
								<h3 class="mt-5 ms-3 Montserrat">No Active Assignments</h3>
								<h5 class="text-secondary ms-3 mb-5">It's a good time to work on your skills to be ready for the next SIMS activation! Check out the <a href='/resources'>learning and development section</a> to find useful resources.</h5>
								
							{% else %}
							<h3 class="mt-5 Montserrat">Active Deployments: <span class='text-danger'>{{count_active_assignments}}</span></h3>
							<table class='table table-striped table-hover' id='datatable-active-assignments'>
								<thead>
									<tr>
										<th>Member</th>
										<th>Affiliation</th>
										<th>Emergency</th>
										<th>Assignment</th>
										<th>End Date</th>
									</tr>
								</thead>
								<tbody>
									{% for assignment in active_assignments %}
										<tr>
											<td class="fw-bold"><a href="/profile/view/{{assignment.Assignment.user_id}}" class='link-danger'>{{assignment.User.firstname}} {{assignment.User.lastname}}</a></td>
											<td>{{assignment.NationalSociety.ns_name}}</td>
											<td><a href="/emergency/{{assignment.Assignment.emergency_id}}" class='link-danger'>{{assignment.Emergency.emergency_name}}</a></td>
											<td><a href='/assignment/{{assignment.Assignment.id}}'>{{assignment.Assignment.role}}</a></td>
											<td>{{assignment.Assignment.end_date.strftime('%B %d, %Y')}}</td>
										</tr>
									{% endfor %}
								</tbody>
							</table>
							{% endif %}
						</div>
						
						
						<h3 class="mt-5 ms-3 Montserrat">Regional IM Focal Points</h3>
						<div class="row row-cols-xxl-5 row-cols-lg-5 row-cols-md-4 row-cols-sm-2 row-cols-2 g-4 mt-4">
							{% for lead in regional_im_leads %}
							<div class="col d-flex align-items-stretch">
								<a href='/profile/view/{{lead.User.id}}' class='text-dark'>
									<div class="card portfolio-card">
										<div class="card-header border-0">
											<span class="fw-bold">{{ "MENA" if lead.Region.name == "Middle East & North Africa" else lead.Region.name }}
</span>
										</div>
										<img src="/uploads/{{lead.User.image_file}}" class="card-img-top">
										<div class="card-body d-flex flex-column">
											<h5 class="card-title mt-auto mb-2 Montserrat sims-blue">{{lead.User.firstname}} <br>{{lead.User.lastname}}</h5>
										</div>
										<ul class="list-group list-group-flush mb-1">
											{% if lead.User.place_label != None %}
											<li class="list-group-item text-secondary" style="font-size: .8rem">{{lead.User.place_label}}</li>
											{% endif %}
										</ul>

								</a>
							</div>
						</div>
						{% endfor %}
						
					</div>
						
						
					</div>
					<div class="tab-pane fade" id="surge-alerts" role="tabpanel" aria-labelledby="surge-alerts-tab">
						<div class='row'>
							<table class='table table-striped table-hover w-100' id='alert-table'>
					  		<thead>
								<tr>
						  		<th><h5 class='Montserrat'>Profile</h5></th>
						  		<th><h5 class='Montserrat'>Emergency</h5></th>
						  		<th><h5 class='Montserrat'>Country</h5></th>
						  		<th><h5 class='Montserrat'>Level</h5></th>
						  		<th><h5 class='Montserrat'>Scope</h5></th>
						  		<th><h5 class='Montserrat'>Alert Date</h5></th>
						  		<th><h5 class='Montserrat'>IM</h5></th>
						  		<th><h5 class='Montserrat'>iso3</h5></th>
								<th><h5 class='Montserrat'>Molnix ID</h5></th>
								</tr>
					  		</thead>
					  		<tbody>
								{% for alert in surge_alerts %}
						  		<tr>
									<td class="fw-bold text-dangeralign-middle">{{alert.role_profile}}</td>
									<td class="align-middle fw-bold"><a href='https://go.ifrc.org/emergencies/{{alert.event_go_id}}'>{{alert.event}}</a></td>
									<td class="align-middle">{{alert.country_name}}</td>
									<td class="align-middle">{{alert.ifrc_severity_level_display}}</td>
									<td class="align-middle">{{alert.scope}}</td>
									<td class="align-middle">{{alert.start.strftime('%b %d, %Y')}}</td>
									<td class="align-middle">{{alert.im_filter}}</td>
									<td class="align-middle">{{alert.iso3}}</td>
									<td class="align-middle">{{alert.molnix_id}}</td>
									
						  		</tr>
								{% endfor %}
					  		</tbody>
							</table>
						</div>
					</div>
				<div class="tab-pane fade" id="data-overview" role="tabpanel" aria-labelledby="data-overview-tab">
						<div class='mt-1'>
						<ul class="nav nav-tabs" id="dashboardNav" role="tablist">
							<li class="nav-item" role="presentation">
								<button class="nav-link active text-danger" id="assignments-emergency-tab" data-bs-toggle="tab" data-bs-target="#assignments-emergency" type="button" role="tab" aria-controls="assignments-emergency" aria-selected="true">Assignments by Emergency</button>
							</li>
					
							<li class="nav-item" role="presentation">
								<button class="nav-link text-danger" id="products-emergency-tab" data-bs-toggle="tab" data-bs-target="#products-emergency" type="button" role="tab" aria-controls="products-emergency" aria-selected="false">Products by Emergency</button>
							</li>
							
						</ul>
						<div class="tab-content" id="dashboardContent">

						  <div class="tab-pane fade show active" id="assignments-emergency" role="tabpanel" aria-labelledby="assignments-emergency-tab">
							  <br>
							  <canvas id='barChartAssignments'></canvas>
							  <script>
								  var ctx = document.getElementById('barChartAssignments').getContext('2d');
								  var lineChart = new Chart(ctx, {
									  type: 'bar',
									  data: {
										  labels: {{ labels_for_assignment | safe }},
										  datasets: [{
											  label: "Assignments by Emergency, All Time",
											  data: {{ values_for_assignment | safe }},
											  fill: true,
											  backgroundColor: "#dc3545"
										  }]
									  },
									  options: {
										  responsive: true,
										  indexAxis: 'y',
										  scales: {
											  y: {
												  ticks: {
													  stepSize: 1
												  },
												  grid: {
													  display: false
												  }
												  
											  },
											  x: {
												  grid: {
													  display: false
												  }
											  }
											  
										  }
									  }
								  })
							  </script>
							  
						  </div>
						  <div class="tab-pane fade" id="products-emergency" role="tabpanel" aria-labelledby="products-emergency-tab">
							  <br>
								<canvas id='barChartProducts'></canvas>
								<script>
									var ctx = document.getElementById('barChartProducts').getContext('2d');
									var lineChart = new Chart(ctx, {
										type: 'bar',
										data: {
											labels: {{ labels_for_product | safe }},
											datasets: [{
												label: "Products by Emergency, All Time",
												data: {{ values_for_product | safe }},
												fill: true,
												backgroundColor: "#dc3545"
											}]
										},
										options: {
											responsive: true,
											indexAxis: 'y',
											scales: {
												y: {
													ticks: {
														stepSize: 1
													},
													grid: {
														display: false
													}
													
												},
												x: {
													grid: {
														display: false
													}
												}
												
											}
										}
									})
								</script>
							  
						  </div>
						</div>
						</div>
					</div>
					</div>
					
				</div>
			</div>
		</div>
	</div>
{% endblock content %}

